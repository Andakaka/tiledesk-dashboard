<div class="navbar-brand" style="z-index: -1;margin-top:10px; padding-left:30px">
  <i class="material-icons" style="vertical-align: middle !important; cursor: pointer;" (click)="goBack()">keyboard_arrow_left</i>
  <!-- Request  -->
  {{ "RequestMsgsPage.Request" | translate }}
  <code style="color:#3f87a6; border: 1px solid #cee9f9; font-size:0.8em"> {{cut_support_group_from_request_id(id_request)}} </code>
</div>

<div class="main-content" style="padding-top:0px">
  <div class="container-fluid">

    <loading-spinner *ngIf="showSpinner"></loading-spinner>
    <div *ngIf="!showSpinner" class="row is-flex">

      <div class="col-sm-7">
        <div class="card" style="padding-top:0px; padding-bottom:0px; padding-left:25px; padding-right:25px" >
            <h4 class="card-title" style="text-transform: none; color: #566787; font-weight:600; margin-top: 18px; margin-bottom: 0px; border-bottom: 1px solid #eeeeee; padding-bottom: 15px;">
                <!-- Request  -->
                {{ "RequestMsgsPage.MessagesOfTheRequest" | translate }}
                <code style="color: #566787; font-weight: 400" >{{cut_support_group_from_request_id(id_request)}} </code>
              </h4>
          <div #scrollMe class="card-content" style="height: 500px; overflow-y: auto;" (scroll)="onScroll($event)">

            <!-- OLD CHAT -->
            <!-- <div *ngFor="let message of messagesList" style="vertical-align:baseline">
              <div class="row">
                <div class="col-sm-11" style="padding-left: 0px; ">
                  <div class="msg_sender" style="padding-right: 0px">
                    <p style="font-size: 0.8em; margin-bottom:0px">
                      <strong> {{ message.sender_fullname }} </strong> 
                    </p>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-12">
                  <div class="talk-bubble tri-right left-top" style="margin-bottom: 12px; min-width: 450px;">
                    <div class="talktext">
                      <div class="col-xs-8">
                        <p style="padding: 10px; margin-bottom: 0px; font-size: 13px; font-family: Tahoma, Verdana, Segoe, sans-serif;">
                          {{ message.text }}
                        </p>
                      </div>
                      <div class="col-xs-4">
                        <span class="time-right" style="font-size: 11px; padding-right: 10px; padding-bottom: 5px; padding-top: 10px">
                          {{ message.timestamp | date: 'd/M/y HH:mm:ss'}}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div> -->

            <div class="chat-body" style="vertical-align:baseline">
              <div style="padding-bottom: 3px;" class="answer left" *ngFor="let message of messagesList">
                <div class="avatar" style="  width: 35px; height: 35px; position: absolute;">
                  <!-- <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="User name" style="display: block;border-radius: 20px; height: 100%; margin-top: 35px;"> -->
                  <div style="display: block;border-radius: 20px; height: 100%; margin-top: 35px; background-color: #ebebeb">
                    <span class="senderFullname" style="position: absolute; top:43px; margin-left:13px; color: #999999; text-transform: uppercase">
                      {{ messageSenderInitialLetter( message.sender_fullname )}}
                    </span>
                  </div>
  
                </div>
                <div class="name">
                  <strong>{{ message.sender_fullname }}</strong>
                </div>
                <div class="row">
  
                <div class="col-xs-11 text" style=" margin-left: 6px; vertical-align: middle; padding-top: 5px;padding-bottom: 5px;">
                  <!-- <div class="text"> -->
                        <!-- <div  style=" background: #ebebeb; height: 100%; float: right"> -->
                          <span class="messageTime" style=" float: right; padding-right: 0px; font-size: 11px; color:#aaa">
                              {{ message.timestamp | date: 'd/M/y HH:mm:ss'}}
                          </span>
                        <!-- </div> -->
                        <div class="col-xs-8 col-sm-8 col-lg-8" style=" padding-left: 5px; padding-top: 5px;">
                            <!-- min-width: 300px; -->
                          <div class="messageText" style="font-size: 13px; line-height: normal; ">
                              {{ message.text }}
                              
                          </div>
                        </div>
                  <!-- </div> -->


                </div>

                
                </div>
                <!-- <div class="time">5 min ago</div> -->
              </div>
            </div>
           
            <a id="fixed-button"  class="button" [ngStyle]="{'display':displayBtnScrollToBottom }" (click)="scrollToBottom()" >
              <span class="icon is-small">
                <i class="fa fa-chevron-down"></i>
              </span>
            </a>

          </div>

          <div class="card-footer" style="text-align: center; margin-bottom: 0px;padding-top: 2px;">
            <div class="stats" style="width: 100%;">
                <!--target="_blank" href="{{ CHAT_BASE_URL }}?recipient={{id_request}}"   -->
              <!-- OPEN THE CHAT -->
              <span *ngIf="HAS_COMPLETED_JOIN_TO_GROUP_POST_REQUEST === true || IS_CURRENT_USER_JOINED === true">
                <button (click)="openChatInNewWindow()" class="btn btn-info" role="button" 
                style="padding:12px 16px !important; margin-left:92px" [disabled]="request?.support_status == 1000"
                [ngClass]="{'disable_open_the_chat_btn' : request?.support_status == 1000}">   
                  <!-- Entra // changed the translation FROM 'Enter' in 'Open the chat' -->
                  <i class="material-icons" style="vertical-align: middle;  top:0px !important; padding-bottom: 2px;">open_in_new</i>
                 <span style="vertical-align: middle"> {{ 'RequestMsgsPage.OpenTheChat' | translate }}</span>
                </button>
              </span>

              <!-- ENTER -->
              <span *ngIf="JOIN_TO_GROUP_HAS_ERROR === false 
                  && IS_CURRENT_USER_JOINED === false 
                  && SHOW_JOIN_TO_GROUP_SPINNER_PROCESSING === false 
                  && HAS_COMPLETED_JOIN_TO_GROUP_POST_REQUEST === false">
                <button class="btn btn-default" (click)="onJoinHandled()" 
                  style="padding:12px 37px !important; margin-left:92px" [disabled]="request?.support_status == 1000">
                  <!-- Join // changed the translation to 'Join' in 'Enter' -->
                 {{ 'RequestMsgsPage.Enter' | translate }}
                </button>
              </span>

              <!-- LOADING BTN -->
              <span *ngIf="SHOW_JOIN_TO_GROUP_SPINNER_PROCESSING === true 
                  && HAS_COMPLETED_JOIN_TO_GROUP_POST_REQUEST === false  
                  && JOIN_TO_GROUP_HAS_ERROR === false">
                <button class="btn btn-default" style="padding:12px 16px !important; margin-left:92px" btn-block>
                  <i class="fa fa-spinner fa-spin" style="margin-right: 5px;"></i> 
                    <!-- Elaborazione -->
                    {{ 'RequestMsgsPage.Loading' | translate }}
                </button>
              </span>

              <!-- IF THE CALLBALL JOIN-TO-GROUP HAS ERROR SHOWS THE BTN ERROR (DISABLED)  -->
              <span *ngIf="JOIN_TO_GROUP_HAS_ERROR === true">
                <button class="btn btn-danger" disabled style="padding:12px 16px !important; margin-left:92px">
                  <!-- Error -->
                  {{ 'RequestMsgsPage.Error' | translate }}
                </button>
              </span>
              <!-- box-shadow: 0 2px 2px 0 rgba(0, 188, 212, 0) -->
              <!-- ARCHIVE REQUEST BTN -->
              <button type="button" rel="tooltip" title="{{ 'VisitorsPage.tootipArchiveRequest' | translate }}" class="btn btn-info pull-right archive_btn"
                (click)='openArchiveRequestModal(request?.recipient)' style="vertical-align: middle; padding: 12px 11px;" 
                [ngClass]="{'disable_archive_btn' : request?.support_status == 1000}" [disabled]="request?.support_status == 1000">
                <i class="material-icons" style="vertical-align: middle; top:0px !important; padding-bottom: 2px;">
                  archive
                </i>
                {{ 'RequestMsgsPage.Archive' | translate }}
              </button>

              
            </div>
          </div>
        </div>  
        <!-- ./ card   -->
      </div>
      <!-- ./ col-md-7 -->

      <!-- // SIDEBAR // -->
      <div class="col-sm-5">
        <div class="card" style="padding-top:5px; padding-bottom:5px;">

          <div class="card-content" style="padding-top:5px;">
            <h4 class="card-title requestattibutestitle" style="text-transform: none; color: #566787; font-weight:600; margin-bottom: 16px; border-bottom: 1px solid #eeeeee; padding-bottom: 15px;">
              <!-- Request  -->
              <span class="requestattibutes">{{ "RequestMsgsPage.RequestAttributes" | translate }}</span>

              <!-- {{ request?.timestamp | amTimeAgo }} -->
              <span class="requestattibutestime" style="font-size: 14px; color:#999999; float: right;">
                  <i class="material-icons" style="vertical-align: middle">access_time</i>
                  <span style="vertical-align: middle; font-weight: 500">
                    {{ "RequestMsgsPage.Published" | translate }}: {{ request?.created_on | amTimeAgo }}
                  </span>
              </span>
              
            </h4>

            <p style="margin-bottom: 10px"> 

              <!-- IF IS AN CLOSED REQUEST -->
              <span *ngIf="request?.support_status == 1000"> 
                <i style="font-size: 24px !important; vertical-align: middle; color: #999999" class="material-icons">visibility</i>
              
                <span style="vertical-align: middle; color: #999999">
                  <strong>
                    <!-- Request closed  -->
                    {{ "RequestMsgsPage.RequestClosed" | translate }}
                  </strong>
                </span>
              </span>

              <!-- IF IS AN UNSERVED REQUEST -->
                <span *ngIf="request?.support_status == 100"> 
                <i style="font-size: 24px !important; vertical-align: middle; color: #f44336" class="material-icons">visibility</i>
              
                <span style="vertical-align: middle; color: #f44336">
                  <strong>
                    <!-- Request unserved  -->
                    {{ "RequestMsgsPage.RequestUnserved" | translate }}
                  </strong>
                </span>
              </span>

              <!-- IF IS A SERVED REQUEST AND BETWEEN THE MEMBERS THERE IS THE CURRENT USER -->
              <span *ngIf="request?.support_status == 200 && request?.currentUserIsJoined === true"> 
                <i style="font-size: 24px !important; vertical-align: middle; color: #4CAF50" class="material-icons">visibility</i>
              
                <span style="vertical-align: middle; color: #4CAF50">
                  <strong>
                    <!-- Request served by:  -->
                    {{ "RequestMsgsPage.RequestServedBy" | translate }}
                  </strong>
                </span>

              </span>

              <span *ngIf="request?.support_status == 200 && !request?.currentUserIsJoined"> 
                <i style="font-size: 24px !important; vertical-align: middle; color: #00bcd4" class="material-icons">visibility</i>
              
                <span style="vertical-align: middle; color: #00bcd4;">
                  <strong>
                    <!-- Request served by:  -->
                    {{ "RequestMsgsPage.RequestServedBy" | translate }}
                  </strong>
                </span>
              </span>


              <span *ngFor="let m of members_array"  style="">
                <span *ngIf="m !== request?.requester_id && m !== 'system' && m !== currentUserID"> 
                  <span class="tag_member" (click)="goToMemberProfile( m )" [innerHTML]="members_replace( m )" style="cursor: pointer;"> 
                    
                  </span>
                </span> 
                <span *ngIf="m === currentUserID" style=""> 
                    <span class="tag_member_me"> ME </span>
                </span>
              </span>   
            </p>

            <!-- PUBLISHED (from now format) -->
            <!-- <p style="margin-bottom: 3px; color:#566787; padding-top: 10px;"> 
              <strong>
                {{ "RequestMsgsPage.Published" | translate }}
               </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ request?.timestamp | amTimeAgo }}
            </p> -->

            <!-- PUBLISHED -->
            <!-- <p style="margin-bottom: 3px; color:#566787; padding-top: 10px;"> 
              <strong>
                {{ "RequestMsgsPage.Published" | translate }} 
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ request?.created_on | date: 'd/M/y HH:mm:ss' }}
            </p> -->
            
            <!-- REQUEST ID -->
            <p style="margin-bottom: 3px; color:#566787; padding-top: 10px;"> 
              <strong>
                {{ "RequestMsgsPage.RequestId" | translate }}
                </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
                {{ id_request }}
            </p>
 
            <!-- <p style="margin-bottom: 3px; color:#566787"> 
              <strong>Request Id </strong>
            </p>
              <p style="color:#999999; font-weight: 500">    
              {{ id_request }}
            </p> -->

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Requester  -->
                {{ "RequestMsgsPage.Requester" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ requester_fullname }} 
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Requester Id -->
                {{ "RequestMsgsPage.RequesterId" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ requester_id }}
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Chat form: user name -->
                {{ "RequestMsgsPage.ChatFormUserName" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ user_name }}
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Chat form: user email -->
                {{ "RequestMsgsPage.ChatFormUserEmail" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              
              <a *ngIf="user_email !== 'n.a.'" href="mailto:{{user_email}}">{{ user_email }}</a>
              <a *ngIf="user_email === 'n.a.'" style="color:#999999;">{{ user_email }}</a>
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Department Name -->
                {{ "RequestMsgsPage.DepartmentName" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ department_name }}
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Department Id -->
                {{ "RequestMsgsPage.DepartmentId" | translate }}
              </strong>
            </p>
            <p style="color:#999999; font-weight: 500">  
              {{ department_id }}
            </p>

            <p style="margin-bottom: 3px; color:#566787"> 
              <strong>
                <!-- Source page -->
                {{ "RequestMsgsPage.SourcePage" | translate }}
              </strong>
            </p>
            <p style="color:#999999; word-wrap: break-word; font-weight: 500">  
              
              <a href="{{source_page}}" target="_blank">{{source_page}}</a>
            </p>

          </div>
        </div>

      </div>

    </div>
    <!-- ./ row -->

  </div>
</div>

<!-- ============= ARCHIVIVE REQUEST MODAL ============= -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{'display':displayArchiveRequestModal}" style="background-color: rgba(90,90,90,0.5);">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
        <!-- background-color:#ff5252; -->
      <div class="modal-header" style="padding-bottom:24px">
        <button type="button" class="close" aria-label="Close" (click)="onCloseArchiveRequestModal()">
            <!-- color: #fff -->
          <span aria-hidden="true" style="">&times;</span>
        </button>
        <h4 class="modal-title" style="color: #00bcd4">
            <i class="material-icons" style="vertical-align: middle">info</i>
            <span style="vertical-align: middle; padding-left:8px">
              <!-- Elimina richiesta -->
              {{ "VisitorsPage.ArchiveRequest" | translate }}
            </span>
        </h4>
        <!-- padding-left: 36px  -->
        <h4 class="modal-title" style="color: #566787; padding-top:10px; font-size: 1.1em;">
          <!-- La richiesta con ID: <code>{{ id_request_to_delete }}</code> verrà eliminata -->
          {{ "VisitorsPage.TheRequestWithId" | translate }} <code style="color: #566787">{{ id_request_to_archive }}</code> {{ "VisitorsPage.WillBeArchived" | translate }} 
        </h4>
      </div>
      <div class="modal-body">
          <p style="font-weight:500; text-align: left; margin-top: 10px; color: #999">
            <!-- Sei sicuro di voler rimuovere la richiesta selezionata? -->
            {{ "VisitorsPage.AreYouSure" | translate }}
          </p>

      </div>
      <div class="modal-footer" style="margin-top: 0px;">
        <button class="btn btn-white" (click)="onCloseArchiveRequestModal()" style="padding:12px 16px;">
          <!-- Annulla -->
          {{ "VisitorsPage.Cancel" | translate }}
        </button>
        <button style="margin-top:0px" class="btn btn-info" (click)="archiveTheRequestHandler()" style="padding:12px 16px;">
          <!-- Archivia Richiesta -->
          {{ "VisitorsPage.ArchiveRequest" | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============ INFO MODAL: ARCHIVING REQUEST IN PROGRESS ============ -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{'display': displayArchivingInfoModal}" style="background-color: rgba(90,90,90,0.5);">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" aria-label="Close" (click)="onCloseArchivingInfoModal()">
          <span aria-hidden="true">&times;</span>
        </button>

        <h4 class="modal-title">
            {{ "VisitorsPage.ArchiveRequest" | translate }}
          <!-- <code>{{id_toDelete}}</code> -->
        </h4>
      </div>

      <div class="modal-body" style="padding-right: 15px; padding-top:15px; padding-bottom:15px">
      
        <span *ngIf="SHOW_CIRCULAR_SPINNER">
          <div  class="loader" style="top:25%;">
            <svg class="circular" viewBox="25 25 50 50">
              <circle class="path" cx="50" cy="50" r="15" fill="none" stroke-width="2" stroke-miterlimit="10"/>
            </svg>

          </div>
          <p style="margin-top: 60px; text-align: center; color: #566787; font-weight: 500">
              {{ "VisitorsPage.Processing" | translate }}
          </p>
        </span>

        <span *ngIf="!SHOW_CIRCULAR_SPINNER && !ARCHIVE_REQUEST_ERROR ">
            
          <div style="text-align: center">
            <i class="material-icons" style="color:#70b665">done</i>
            <p style="color:#70b665; font-weight: 500">
                {{ "VisitorsPage.Completed" | translate }}
            </p> 

          </div>
          <p style="margin-top:10px; text-align: center; color: #566787; font-weight: 500">
              {{ "VisitorsPage.RequestArchived" | translate }}
          </p>
        </span>

        <!-- IF THERE IS AN ERROR -->
        <span *ngIf="!SHOW_CIRCULAR_SPINNER && ARCHIVE_REQUEST_ERROR ">
          
          <div style="text-align: center ">
            <i class="material-icons" style="color:#ff5252">report_problem</i>
            <p style="color:#ff5252; font-weight: 500">
                {{ "VisitorsPage.Error" | translate }}
            </p> 

          </div>
          <p style="margin-top:10px; text-align: center; color: #566787; font-weight: 500">
              {{ "VisitorsPage.AnErrorHasOccurred" | translate }}
          </p>
        </span>
      </div>

      <div class="modal-footer" style="text-align: center;">
        <button class="btn btn-info" [disabled]="SHOW_CIRCULAR_SPINNER" (click)="onCloseArchivingInfoModal()" style="padding:12px 16px;">
            {{ "VisitorsPage.Continue" | translate }}
        </button>
      </div>

    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>